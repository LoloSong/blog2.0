{
    "version": 3,
    "sources": [
        "../../../src/home/controller/post.js"
    ],
    "names": [
        "stats",
        "think",
        "promisify",
        "stat",
        "indexAction",
        "listAction",
        "model",
        "where",
        "tag",
        "get",
        "cate",
        "name",
        "find",
        "user",
        "isEmpty",
        "user_id",
        "id",
        "tagName",
        "cateName",
        "pathname",
        "statusAction",
        "http",
        "assign",
        "filter",
        "toLowerCase",
        "getPostList",
        "list",
        "data",
        "forEach",
        "post",
        "encodeURIComponent",
        "options",
        "JSON",
        "parse",
        "featuredImage",
        "e",
        "pagination",
        "posts",
        "displayView",
        "detailAction",
        "url",
        "decodeURIComponent",
        "detail",
        "previewData",
        "getContentAndSummary",
        "getPostDetail",
        "redirect",
        "pageAction",
        "setRelation",
        "is_public",
        "type",
        "status",
        "template",
        "join",
        "THEME_VIEW_PATH",
        "sep",
        "slice",
        "console",
        "log",
        "archiveAction",
        "getPostArchive",
        "i",
        "map",
        "tagAction",
        "searchAction",
        "keyword",
        "trim",
        "postModel",
        "getPostSearch",
        "searchResult",
        "tagModel",
        "getHotTags",
        "hotTags"
    ],
    "mappings": "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",
    "file": "../../../src/home/controller/post.js",
    "sourcesContent": [
        "'use strict';\n\nimport fs from 'fs';\nimport path from 'path';\nimport Base from './base';\n\nconst stats = think.promisify(fs.stat);\n\n\nexport default class extends Base {\n  /**\n   * index action\n   * @return {[type]} [description]\n   */\n  indexAction() {\n    return this.listAction();\n  }\n  /**\n   * post list\n   * @return {Promise} []\n   */\n  async listAction() {\n    let model = this.model('post');\n    let where = {\n      tag: this.get('tag'),\n      cate: this.get('cate')\n    };\n    if(this.get('name')) {\n      let user = await this.model('user').where({name: this.get('name')}).find();\n      if(!think.isEmpty(user)) {\n        where.where = {user_id: user.id};\n      }\n    }\n\n    let tagName = '', cateName = '';\n    if(where.tag) {\n      tagName = await this.model('tag').where({pathname: where.tag}).find();\n      if(!think.isEmpty(tagName)) {\n        tagName = tagName.name;\n      } else {\n        return think.statusAction(404, this.http);\n      }\n    }\n    if(where.cate) {\n      [cateName] = this.assign('categories').filter(cate =>\n        cate.pathname.toLowerCase() === where.cate.toLowerCase()\n      );\n      if (cateName && cateName.name) {\n        cateName = cateName.name;\n      } else {\n        return think.statusAction(404, this.http);\n      }\n    }\n\n    let list = await model.getPostList(this.get('page'), where);\n    list.data.forEach(post => {\n      post.pathname = encodeURIComponent(post.pathname);\n      try {\n        post.options = JSON.parse(post.options) || {};\n        post.featuredImage = post.options.featuredImage;\n      } catch (e) {\n        post.options = {};\n        post.featuredImage = '';\n      }\n    });\n    let {data, ...pagination} = list;\n    this.assign({\n      posts: data,\n      pagination,\n      tag: tagName,\n      cate: cateName,\n      pathname: where.tag || where.cate\n    });\n    return this.displayView('index');\n  }\n  /**\n   * post detail\n   * @return {[type]} [description]\n   */\n  async detailAction() {\n    this.http.url = decodeURIComponent(this.http.url);\n    let pathname = this.get('pathname');\n    if(pathname === 'list') { return this.listAction(); }\n    let detail;\n    if(this.get('preview')) {\n      try {\n        let previewData = JSON.parse(this.post('previewData'));\n        detail = await think.model('post', null, 'admin').getContentAndSummary(previewData);\n      } catch (e) {\n        // Ignore JSON parse error\n      }\n    }\n\n    detail = detail || await this.model('post').getPostDetail(pathname);\n    if(think.isEmpty(detail)) {\n      return this.redirect('/');\n    }\n    detail.pathname = encodeURIComponent(detail.pathname);\n    try {\n      detail.options = JSON.parse(detail.options) || {};\n      detail.featuredImage = detail.options.featuredImage;\n    } catch (e) {\n      detail.options = {};\n      detail.featuredImage = '';\n    }\n    this.assign('post', detail);\n\n    return this.displayView('post');\n  }\n\n  async pageAction() {\n    let pathname = this.get('pathname');\n    let detail;\n    if(this.get('preview')) {\n      try {\n        let previewData = JSON.parse(this.post('previewData'));\n        detail = await think.model('post', null, 'admin').getContentAndSummary(previewData);\n      } catch (e) {\n        // Ignore JSON parse error\n      }\n    }\n    detail = detail || await this.model('post')\n      .setRelation(false)\n      .where({\n        pathname,\n        is_public: 1, //公开\n        type: 1, //文章\n        status: 3 //已经发布\n      })\n      .find();\n    detail.pathname = encodeURIComponent(detail.pathname);\n    try {\n      detail.options = JSON.parse(detail.options) || {};\n      detail.featuredImage = detail.options.featuredImage;\n    } catch (e) {\n      detail.options = {};\n      detail.featuredImage = '';\n    }\n    this.assign('page', detail);\n    this.assign('pathname', pathname);\n\n    let template = 'page';\n    if(detail.options) {\n      try {\n        if(detail.options.template) {\n          /*let stat = */await stats(path.join(this.THEME_VIEW_PATH, 'template', detail.options.template));\n          template = `template${think.sep}`+detail.options.template.slice(0, -5);\n        }\n      } catch(e) {\n        console.log(e);  // eslint-disable-line no-console\n      }\n    }\n\n    return this.displayView(template);\n  }\n  /**\n   * post archive\n   * @return {[type]} [description]\n   */\n  async archiveAction() {\n    let model = this.model('post');\n    let data = await model.getPostArchive();\n    for(let i in data) { data[i].map(post => post.pathname = encodeURIComponent(post.pathname)) }\n    this.assign('list', data);\n    return this.displayView('archive');\n  }\n\n  async tagAction() {\n    return this.displayView('tag');\n  }\n  /**\n   * search action\n   * @return {[type]} [description]\n   */\n  async searchAction() {\n    let keyword = this.get('keyword').trim();\n    if(keyword) {\n      let postModel = this.model('post');\n      let searchResult = await postModel.getPostSearch(keyword, this.get('page'));\n      this.assign('searchData', searchResult);\n      this.assign('pagination', searchResult);\n    }\n\n    //热门标签\n    let tagModel = this.model('tag');\n    let hotTags = await tagModel.getHotTags();\n    this.assign('hotTags', hotTags);\n\n\n    this.assign('keyword', keyword);\n    return this.displayView('search');\n  }\n}\n"
    ]
}