{
    "version": 3,
    "sources": [
        "../../../src/home/controller/index.js"
    ],
    "names": [
        "indexAction",
        "model",
        "getOptions",
        "frontPage",
        "get",
        "action",
        "opensearchAction",
        "http",
        "type",
        "end",
        "options",
        "title",
        "description",
        "site_url",
        "rssAction",
        "getPostRssList",
        "list",
        "assign",
        "Date",
        "toString",
        "display",
        "HOME_VIEW_PATH",
        "sitemapAction",
        "postModel",
        "postList",
        "getPostSitemapList",
        "installAction",
        "step",
        "param",
        "InstallService",
        "service",
        "instance",
        "ip",
        "message",
        "isGet",
        "firekylin",
        "isInstalled",
        "redirect",
        "dbConfig",
        "config",
        "adapter",
        "isDBConfig",
        "think",
        "isObject",
        "host",
        "port",
        "database",
        "user",
        "checkInstalled",
        "fail",
        "errors",
        "isEmpty",
        "data",
        "post",
        "siteInfo",
        "username",
        "password",
        "saveSiteInfo",
        "dbInfo",
        "db_host",
        "db_port",
        "db_name",
        "db_account",
        "db_password",
        "prefix",
        "db_table_prefix",
        "saveDbInfo",
        "contributorAction",
        "hasOwnProperty",
        "push",
        "USER_CONTRIBUTOR",
        "status",
        "USER_DISABLED",
        "create_time",
        "datetime",
        "last_login_time",
        "create_ip",
        "last_login_ip",
        "where",
        "name",
        "email",
        "_logic",
        "thenAdd"
    ],
    "mappings": "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",
    "file": "../../../src/home/controller/index.js",
    "sourcesContent": [
        "'use strict';\n\nimport Base from './base';\n\nexport default class extends Base {\n  /**\n   * 首页如果设置了自定义首页则渲染对应页面\n   * @return {[type]} [description]\n   */\n  async indexAction() {\n    let {frontPage} = await this.model('options').getOptions();\n    if(frontPage) {\n      this.get('pathname', frontPage);\n      return this.action('post', 'page');\n    }\n\n    return this.action('post', 'list');\n  }\n\n  /**\n   * 输出opensearch\n   */\n  opensearchAction() {\n    this.http.type('text/xml');\n\n    return this.end(`<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<OpenSearchDescription xmlns=\"http://a9.com/-/spec/opensearch/1.1/\">\n    <ShortName>${this.options.title}</ShortName>\n    <Description>${this.options.description}</Description>\n    <Url type=\"text/html\" template=\"${this.options.site_url}/search.html?s={searchTerms}\" />\n</OpenSearchDescription>`);\n  }\n\n  /**\n   * rss\n   * @return {[type]} [description]\n   */\n  async rssAction() {\n    let model = this.model('post');\n    let list = await model.getPostRssList();\n    this.assign('list', list);\n    this.assign('currentTime', (new Date()).toString());\n\n    this.type('text/xml');\n    return super.display(this.HOME_VIEW_PATH + 'rss.xml');\n  }\n\n  /**\n   * sitemap action\n   * @return {[type]} [description]\n   */\n  async sitemapAction() {\n    let postModel = this.model('post');\n    let postList = postModel.getPostSitemapList();\n    this.assign('postList', postList);\n\n    this.type('text/xml');\n    return this.display(this.HOME_VIEW_PATH + 'sitemap.xml');\n  }\n  /**\n   * install\n   * @return {[type]} [description]\n   */\n  async installAction() {\n    let step = this.param('step');\n    let InstallService = this.service('install');\n    let instance = new InstallService(this.ip());\n    let message;\n\n    this.assign({step});\n    if(this.isGet()) {\n      if(firekylin.isInstalled) {\n        return this.redirect('/');\n      }\n\n      /** check db config exist */\n      let dbConfig = this.config('db');\n      dbConfig = dbConfig.adapter[dbConfig.type];\n      let isDBConfig = think.isObject(dbConfig)\n                        && dbConfig.host\n                        && dbConfig.port\n                        && dbConfig.database\n                        && dbConfig.user;\n\n      switch(step) {\n        case 1:\n          if(isDBConfig) {\n            this.redirect('/index/install?step=2');\n          }\n        break;\n\n        case 2:\n          if(!isDBConfig) {\n            this.redirect('/index/install');\n          }\n          if(await InstallService.checkInstalled()) {\n            message = 'success';\n          }\n        break;\n      }\n\n      this.assign({message});\n      return this.display();\n    }\n\n    if(firekylin.isInstalled) {\n      return this.fail('SYSTERM_INSTALLED');\n    }\n\n    let errors = this.assign('errors');\n    if(!think.isEmpty(errors)) {\n      this.assign('message', errors[Object.keys(errors)[0]]);\n      return this.display();\n    }\n\n    let data = this.post();\n\n    switch(data.step) {\n      case 2:\n        let siteInfo = {\n          title: data.title,\n          site_url: data.site_url,\n          username: data.username,\n          password: data.password\n        }\n        try {\n          await instance.saveSiteInfo(siteInfo);\n          message = 'success';\n        } catch(e) {\n          message = e;\n        }\n      break;\n\n      default:\n        let dbInfo = {\n          host: data.db_host,\n          port: data.db_port,\n          database: data.db_name,\n          user: data.db_account,\n          password: data.db_password,\n          prefix: data.db_table_prefix\n        };\n        try {\n          await instance.saveDbInfo(dbInfo);\n          message = 'success';\n        } catch(e) {\n          message = e;\n        }\n      break;\n    }\n\n    this.assign('message', message);\n    this.assign('data', data);\n    this.display();\n  }\n  /**\n   * 申请成为投稿者\n   * @return {[type]} [description]\n   */\n  async contributorAction() {\n    if(!this.options.hasOwnProperty('push') || +this.options.push === 0) {\n      return this.fail('PUSH_CLOSED');\n    }\n    if(this.isGet()) {\n      return this.display();\n    }\n\n    let user = this.post();\n    user.type = firekylin.USER_CONTRIBUTOR;\n    user.status = firekylin.USER_DISABLED;\n    user.create_time = think.datetime();\n    user.last_login_time = user.create_time;\n    user.create_ip = this.ip();\n    user.last_login_ip = this.ip();\n\n    await this.model('user').where({name: user.name, email: user.email, _logic: 'OR'}).thenAdd(user);\n    this.assign('message', 'success');\n    this.display();\n  }\n}\n"
    ]
}